---
// src/pages/projects/[id].astro - Fixed with proper TypeScript types
import type { GetStaticPaths } from "astro";
import ProjectLayout from '../../layouts/ProjectLayout.astro';
import type { ProjectData } from '../../types/project';
import { projects } from '../../data/projects.js';
import type { ImageMetadata } from 'astro';

// Define the project info type based on your projects data structure
interface ProjectInfo {
  id: number;
  number: string;
  name: string;
  location: string;
  image: ImageMetadata;
}

interface PageProps {
  projectInfo: ProjectInfo;
  projectId: string;
}

// Generate static paths for all projects
export const getStaticPaths: GetStaticPaths = async () => {
  const paths = projects.map((project) => {
    const projectId = project.name.toLowerCase().replace(/[\s&]/g, '-').replace(/--+/g, '-');
    
    return {
      params: { 
        id: projectId 
      },
      props: { 
        projectInfo: project,
        projectId: projectId
      } as PageProps
    };
  });
  
  return paths;
};

const { projectInfo, projectId }: PageProps = Astro.props;

// Helper function to safely import images with proper typing
async function safeImageImport(imagePath: string): Promise<ImageMetadata | null> {
  try {
    const imageModules = import.meta.glob('../../assets/projects/**/*.{webp,jpg,jpeg,png}');
    if (imageModules[imagePath]) {
      const module = await imageModules[imagePath]() as { default: ImageMetadata };
      return module.default;
    }
    return null;
  } catch (error) {
    console.warn(`Could not load image: ${imagePath}`, error);
    return null;
  }
}

// Build safe image paths
const basePath = `../../assets/projects/${projectInfo.location.toLowerCase()}/${projectId}`;
const heroImagePath = `${basePath}/main-image.webp`;

// Try to load gallery images safely
const galleryImages: Array<{
  src: ImageMetadata;
  alt: string;
  width: number;
  height: number;
}> = [];

const maxGalleryImages = 10; // Limit to prevent build issues

for (let i = 1; i <= maxGalleryImages; i++) {
  try {
    const imagePath = `${basePath}/gallery-${i}.webp`;
    const image = await safeImageImport(imagePath);
    
    if (image) {
      galleryImages.push({
        src: image,
        alt: `${projectInfo.name} - Gallery Image ${i}`,
        width: 1200,
        height: 800
      });
    }
  } catch (error) {
    // Skip corrupted or missing images
    console.warn(`Skipping gallery image ${i} for ${projectId}:`, error);
    continue;
  }
}

// Use main project image as hero if available, otherwise use fallback
let heroImage: ImageMetadata;
try {
  const loadedHeroImage = await safeImageImport(heroImagePath);
  if (loadedHeroImage) {
    heroImage = loadedHeroImage;
  } else {
    heroImage = projectInfo.image; // Fallback to main project image
  }
} catch (error) {
  console.warn(`Using fallback hero image for ${projectId}:`, error);
  heroImage = projectInfo.image;
}

// If no gallery images found, use the hero image as a gallery item
if (galleryImages.length === 0) {
  galleryImages.push({
    src: heroImage,
    alt: `${projectInfo.name} - Main Image`,
    width: 1200,
    height: 800
  });
}

const projectData: ProjectData = {
  id: projectId,
  name: projectInfo.name,
  location: projectInfo.location,
  description: 'A luxurious residential development offering modern living spaces with stunning views and world-class amenities.',
  heroImage: {
    src: heroImage,
    alt: `${projectInfo.name} - Main View`,
    width: 1920,
    height: 1080
  },
  info: {
    typology: ['Architecture', 'Residential'],
    status: 'Available',
    yearOfDesign: 2023,
    location: `${projectInfo.location} Oceanfront`,
    square: '15,000 m2'
  },
  aboutProject: `${projectInfo.name} represents a pinnacle of modern architectural design, seamlessly blending luxury living with sustainable practices. This prestigious development offers residents an unparalleled lifestyle experience with its thoughtfully designed spaces and premium amenities.

The project features state-of-the-art facilities including infinity pools, landscaped gardens, fitness centers, and 24/7 concierge services. Each unit has been meticulously planned to maximize natural light and ventilation while offering breathtaking views of the surrounding landscape.

Key Features:
- Premium location with easy access to major landmarks
- Sustainable design with energy-efficient systems
- High-end finishes and fixtures throughout
- Smart home integration
- Dedicated parking spaces
- Community spaces for social gatherings`,
  galleryImages: galleryImages
};
---

<ProjectLayout project={projectData} />