---
// src/pages/projects.astro
import Layout from '../layouts/Layout.astro';
import { projects } from '../data/projects.js';
import { Image } from 'astro:assets';
import Navigation from '../components/Navigation.astro';
import BottomNavigation from '../components/BottomNavigation.astro';

// Group projects by location
const emaarProjects = projects.filter(p => p.location === 'Emaar');
const hmrProjects = projects.filter(p => p.location === 'HMR');
const allProjects = [...emaarProjects, ...hmrProjects];
---

<Layout title="Projects - BYG">
  <Navigation />
  <BottomNavigation />
  
  <div class="projects-list-container" id="projectsListContainer">
    {allProjects.map((project, index) => (
      <section 
        class="project-section" 
        id={`project-${project.id}`}
        data-project-id={project.id}
        data-project-name={project.name}
        data-project-location={project.location.toLowerCase()}
        data-project-index={index}
      >
        <div class="project-content">
          <div class="project-header">
            <span class="project-number">{project.number}</span>
            <h1 class="project-title">{project.name}</h1>
            <p class="project-location">{project.location}</p>
          </div>
          
          <div class="project-image-container">
            <Image
              src={project.image}
              alt={project.name}
              width={1920}
              height={1080}
              quality={90}
              format="webp"
              class="project-image"
            />
          </div>
          
          <div class="project-details">
            <a href={`/projects/${project.name.toLowerCase().replace(/[\s&]/g, '-').replace(/--+/g, '-')}`} 
               class="view-details-btn">
              View Project Details
            </a>
          </div>
        </div>
      </section>
    ))}
  </div>
</Layout>

<script define:vars={{ projects }}>
  class ProjectsListController {
    constructor() {
      this.sections = document.querySelectorAll('.project-section');
      this.currentIndex = 0;
      this.isScrolling = false;
      this.projects = projects;
      
      // Wait for DOM to be fully ready before initializing
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.init());
      } else {
        setTimeout(() => this.init(), 50);
      }
    }
    
    init() {
      // Check if we need to scroll to a specific project based on URL hash
      this.handleInitialScroll();
      
      // Setup intersection observer for URL updates
      this.setupIntersectionObserver();
      
      // Setup scroll behavior
      this.setupScrollBehavior();
      
      // Handle navigation clicks
      this.setupNavigationHandlers();
    }
    
    handleInitialScroll() {
      // Check for URL hash (e.g., #project-1)
      const hash = window.location.hash;
      if (hash) {
        const targetElement = document.querySelector(hash);
        if (targetElement) {
          // Small delay to ensure page is fully loaded
          setTimeout(() => {
            targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Update current index
            const projectIndex = parseInt(targetElement.dataset.projectIndex);
            if (!isNaN(projectIndex)) {
              this.currentIndex = projectIndex;
            }
          }, 100);
        }
      }
    }
    
    setupIntersectionObserver() {
      // Add a delay before starting to observe URL changes
      let observerActive = false;
      setTimeout(() => {
        observerActive = true;
      }, 1000);
      
      const options = {
        root: null,
        rootMargin: '-50% 0px -50% 0px',
        threshold: 0
      };
      
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting && observerActive && !this.isScrolling) {
            const projectId = entry.target.dataset.projectId;
            const projectName = entry.target.dataset.projectName;
            const projectLocation = entry.target.dataset.projectLocation;
            
            // Update URL hash without page reload
            const newHash = `#project-${projectId}`;
            if (window.location.hash !== newHash) {
              window.history.replaceState(null, '', newHash);
            }
            
            // Update current index
            this.currentIndex = parseInt(entry.target.dataset.projectIndex);
          }
        });
      }, options);
      
      this.sections.forEach(section => {
        observer.observe(section);
      });
    }
    
    setupScrollBehavior() {
      // Smooth scroll with keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
          e.preventDefault();
          
          if (e.key === 'ArrowDown' && this.currentIndex < this.sections.length - 1) {
            this.scrollToProject(this.currentIndex + 1);
          } else if (e.key === 'ArrowUp' && this.currentIndex > 0) {
            this.scrollToProject(this.currentIndex - 1);
          }
        }
      });
      
      // Add scroll snap behavior
      const container = document.getElementById('projectsListContainer');
      if (container) {
        container.style.scrollSnapType = 'y mandatory';
      }
    }
    
    setupNavigationHandlers() {
      // Handle bottom navigation clicks
      document.addEventListener('click', (e) => {
        const link = e.target.closest('a[href^="#"]');
        if (link) {
          e.preventDefault();
          const section = link.getAttribute('href').substring(1);
          
          if (section === 'emaar') {
            this.scrollToProject(0);
          } else if (section === 'hmr') {
            const hmrIndex = this.projects.findIndex(p => p.location === 'HMR');
            if (hmrIndex !== -1) {
              this.scrollToProject(hmrIndex);
            }
          }
        }
      });
    }
    
    scrollToProject(index) {
      if (index >= 0 && index < this.sections.length) {
        this.isScrolling = true;
        const targetSection = this.sections[index];
        
        targetSection.scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
        
        setTimeout(() => {
          this.isScrolling = false;
        }, 1000);
      }
    }
  }
  
  // Initialize controller when DOM is ready
  if (document.readyState === 'complete') {
    new ProjectsListController();
  } else {
    window.addEventListener('load', () => {
      new ProjectsListController();
    });
  }
</script>

<style>
  .projects-list-container {
    width: 100%;
    height: 100vh;
    overflow-y: scroll;
    overflow-x: hidden;
    scroll-behavior: smooth;
    position: relative;
  }
  
  .project-section {
    min-height: 100vh;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    scroll-snap-align: start;
    background: #fff;
  }
  
  .project-section:nth-child(even) {
    background: #f8f8f8;
  }
  
  .project-content {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
    padding: 60px 40px;
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 60px;
    align-items: center;
  }
  
  .project-header {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .project-number {
    font-size: 14px;
    color: #999;
    font-weight: 500;
  }
  
  .project-title {
    font-size: clamp(48px, 6vw, 80px);
    font-weight: 600;
    line-height: 1.1;
    color: #333;
    margin: 0;
  }
  
  .project-location {
    font-size: 18px;
    color: #666;
    font-weight: 400;
  }
  
  .project-image-container {
    width: 100%;
    height: 70vh;
    overflow: hidden;
    border-radius: 16px;
    box-shadow: 0 40px 80px rgba(0, 0, 0, 0.15);
  }
  
  .project-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .project-section:hover .project-image {
    transform: scale(1.05);
  }
  
  .project-details {
    grid-column: 1 / -1;
    text-align: center;
    margin-top: 40px;
  }
  
  .view-details-btn {
    display: inline-block;
    padding: 16px 40px;
    background: #333;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  
  .view-details-btn:hover {
    background: #000;
    transform: translateY(-2px);
  }
  
  /* Mobile responsive */
  @media (max-width: 1024px) {
    .project-content {
      grid-template-columns: 1fr;
      gap: 40px;
      padding: 40px 20px;
    }
    
    .project-header {
      text-align: center;
    }
    
    .project-image-container {
      height: 50vh;
    }
  }
  
  /* Hide scrollbar but keep functionality */
  .projects-list-container::-webkit-scrollbar {
    width: 0px;
    background: transparent;
  }
  /* Add this to the end of your existing <style> section in projects.astro */

/* Mobile button visibility fix */
@media (max-width: 768px) {
  .project-details {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative;
    z-index: 10;
  }
  
  .view-details-btn {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    background: #333 !important;
    color: white !important;
    padding: 14px 30px;
    font-size: 15px;
    min-height: 44px;
    line-height: 1.2;
  }
}
/* Add this to your existing projects.astro style section */

/* Desktop/Laptop button visibility fix */
@media (min-width: 769px) {
  .project-details {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative;
    z-index: 10;
    grid-column: 1 / -1;
    text-align: center;
    margin-top: 40px;
  }
  
  .view-details-btn {
    display: inline-block !important;
    visibility: visible !important;
    opacity: 1 !important;
    padding: 16px 40px;
    background: #333 !important;
    color: white !important;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 500;
    transition: all 0.3s ease;
    position: relative;
    z-index: 20;
  }
  
  .view-details-btn:hover {
    background: #000 !important;
    transform: translateY(-2px);
  }
}

/* Ensure button is always visible regardless of scroll position */
.project-section {
  position: relative;
}

.project-content {
  position: relative;
  z-index: 1;
}

.project-details {
  position: relative;
  z-index: 10;
}
</style>
